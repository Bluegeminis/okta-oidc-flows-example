<div th:fragment="common" xmlns:th="http://www.thymeleaf.org">
    <script>
    /*<![CDATA[*/
        $(document).ready(function () {

            $('#allthethings').popup({
                opacity: 0,
                transition: 'all 0.5s'
            });

            getFlowType = function () {
                var isCode = $('#code').hasClass('glyphicon-ok');
                var isIdToken = $('#id_token').hasClass('glyphicon-ok');
                var isToken = $('#token').hasClass('glyphicon-ok');

                var flowType = '';
                if (isCode && (isIdToken || isToken)) {
                    flowType = 'hybrid';
                } else if (isCode) {
                    flowType = 'code';
                } else if (isIdToken || isToken) {
                    flowType = 'implicit';
                } else {
                    flowType = 'none_selected';
                }
                return flowType;
            };

            codeUrlBuilder = function () {
                var isCode = $('#code').hasClass('glyphicon-ok');
                var isIdToken = $('#id_token').hasClass('glyphicon-ok');
                var isToken = $('#token').hasClass('glyphicon-ok')

                var responseType =
                    (isCode ? 'code+' : '') +
                    (isIdToken ? 'id_token+' : '') +
                    (isToken ? 'token+' : '');
                if (responseType.endsWith('+')) {
                    responseType = responseType.substring(0, responseType.length - 1);
                }

                var isProfile = $('#profile').hasClass('glyphicon-ok');
                var isEmail = $('#email').hasClass('glyphicon-ok');
                var isAddress = $('#address').hasClass('glyphicon-ok');
                var isPhone = $('#phone').hasClass('glyphicon-ok');

                var scope = 'openid' +
                    (isProfile ? '+profile' : '') +
                    (isEmail ? '+email' : '') +
                    (isAddress ? '+address' : '') +
                    (isPhone ? '+phone' : '');

                if (isCode && isIdToken && isToken && isProfile && isEmail && isAddress && isPhone) {
                    allTheThings();
                }

                var codeUrlParts = [];
                codeUrlParts.push('https://' + $('#okta_org').val() + '/oauth2/');
                codeUrlParts.push($('#auth_server_id').val() + '/v1/authorize?');
                codeUrlParts.push('client_id=' + $('#oidc_client_id').val() + '&');
                codeUrlParts.push('response_type=' + responseType + '&');
                codeUrlParts.push('scope=' + scope + '&');
                codeUrlParts.push('state=' + $('#state').val() + '&');
                codeUrlParts.push('nonce=' + $('#nonce').html() + '&');
                codeUrlParts.push('redirect_uri=' + encodeURIComponent($('#redirect_uri').html()));

                $('#code_url').attr('href', codeUrlParts.join(''));
                $('#code_url').html(codeUrlParts.join('<br/>'));

                var flowType = getFlowType();

                // update on server
                $.ajax({
                    url: '/update_config',
                    type: 'PUT',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({
                        'okta.oidc.client.id': $('#oidc_client_id').val(),
                        'okta.authorizationServer.id': $('#auth_server_id').val(),
                        'okta.org': $('#okta_org').val(),
                        'redirect.uri': $('#redirect_uri').html()
                    }),
                    dataType: 'json'
                });
            };

            allTheThings = function() {
                $('#allthethings').popup('show');
                setTimeout(function () {
                    $('#allthethings').popup('hide');
                }, 1000)
            };

            buttonToggle = function (e) {
                var target = e.currentTarget;
                var child = target.firstElementChild;
                if ($(child).hasClass('glyphicon-ok')) {
                    $(child).removeClass('glyphicon-ok');
                    $(child).addClass('glyphicon-remove');
                    $(target).removeClass('btn-primary');
                } else if ($(child).hasClass('glyphicon-remove')) {
                    $(child).removeClass('glyphicon-remove');
                    $(child).addClass('glyphicon-ok');
                    $(target).addClass('btn-primary');
                }
            };
        });
    /*]]>*/
    </script>
</div>

<div th:fragment="home" xmlns:th="http://www.thymeleaf.org">
    <script>
        /*<![CDATA[*/
            $(document).ready(function () {
                $('.build-code-url').keyup(codeUrlBuilder);

                var flowTypeHandler = function (e) {
                    buttonToggle(e);

                    var flowTypes = ['code', 'implicit', 'hybrid'];
                    flowTypes.forEach(function (localFlowType) {
                        $('#' + localFlowType + '-type').parent().removeClass('bg-success');
                        $('#' + localFlowType + '-type').removeClass('glyphicon-ok');
                        $('#' + localFlowType + '-type').addClass('glyphicon-remove');
                    });

                    var flowType = getFlowType();
                    var flowIdx = flowTypes.indexOf(flowType);
                    if (flowIdx >= 0) {
                        $('#' + flowType + '-type').parent().addClass('bg-success');
                        $('#' + flowType + '-type').addClass('glyphicon-ok');
                        $('#' + flowType + '-type').removeClass('glyphicon-remove');
                    }

                    codeUrlBuilder();
                };
                $('.response-type').click(flowTypeHandler);
                $('.scope').click(function (e) {
                    buttonToggle(e);
                    codeUrlBuilder();
                });

                // set redirect and url properly
                $('#code').parent().click();
            });
        /*]]>*/
    </script>
</div>

<div th:fragment="flow_results" xmlns:th="http://www.thymeleaf.org">
    <script>
        /*<![CDATA[*/
        $(document).ready(function () {
            var query = (location.search)?location.search:location.href.substring(location.href.indexOf('#')+1);
            var urlParams = new URLSearchParams(query);

            if (urlParams.get('code')) {
                $('#code').val(urlParams.get('code'));
                $('#code-section').show();
            }

            if (urlParams.get('id_token')) {
                $('#id_token').val(urlParams.get('id_token'));
                $('#id_token-section').show();
            }

            if (urlParams.get('access_token')) {
                $('#access_token').val(urlParams.get('access_token'));
                $('#access_token-section').show();
            }

            if (urlParams.get('state')) {
                $('#state').val(urlParams.get('state'));
                $('#state-section').show();
            }

            if (urlParams.get('scope')) {
                $('#scope').val(urlParams.get('scope'));
                $('#scope-section').show();
            }

            $('.validate').click(function (e) {
               e.preventDefault();
                $.ajax({
                    url: '/validate',
                    type: 'POST',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({ 'id_token': $('#id_token').val() }),
                    dataType: 'json',
                    success: function (response) {
                        $('#validate').val(JSON.stringify(response.validateResponse, null, '\t'));
                        $('#validate-section').show();
                        $('#jwks_link').html(
                            '<a href="' + response.jwksLink + '" target="_blank">' + response.jwksLink + '</a>'
                        );
                    }
                });
            });

            $('.introspect').click(function (e) {
                e.preventDefault();
                $.ajax({
                    url: '/introspect',
                    type: 'POST',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({ 'access_token': $('#access_token').val() }),
                    dataType: 'json',
                    success: function (response) {
                        $('#introspect').val(JSON.stringify(response.introspectResponse, null, '\t'));
                        $('#introspect-section').show();
                        $('#introspect_link').html(response.introspectLink);
                    }
                });
            });

            $('.userinfo').click(function (e) {
                e.preventDefault();
                $.ajax({
                    url: '/userinfo',
                    type: 'POST',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({ 'access_token': $('#access_token').val() }),
                    dataType: 'json',
                    success: function (response) {
                        $('#userinfo').val(JSON.stringify(response.userinfoResponse, null, '\t'));
                        $('#userinfo-section').show();
                        $('#userinfo_link').html(response.userinfoLink);
                    }
                });
            })
        });
        /*]]>*/
    </script>
</div>



<div th:fragment="chart" xmlns:th="http://www.thymeleaf.org">
    <script>
        /*<![CDATA[*/
        $(document).ready(function () {
            var flowTypeHandler = function (e) {
                buttonToggle(e);

                var flowTypes = ['code', 'implicit', 'hybrid'];
                flowTypes.forEach(function (localFlowType) {
                    $('#' + localFlowType + '-type').removeClass('btn-primary');
                });

                var flowType = getFlowType();
                var flowIdx = flowTypes.indexOf(flowType);
                if (flowIdx >= 0) {
                    $('#' + flowType + '-type').addClass('btn-primary');
                }
            };
            $('.response-type').click(flowTypeHandler);
            $('.scope').click(buttonToggle);
        });
        /*]]>*/
    </script>
</div>